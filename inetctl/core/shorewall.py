from pathlib import Path
from typing import Dict, List
import re

from inetctl.core.utils import get_active_leases

# The apply_shorewall_config function remains the same and is correct.
def apply_shorewall_config(file_path_str: str, new_content: str, managed_block_name: str = None) -> bool:
    # ... This function is unchanged from the last working version ...

def generate_accounting_rules(config: Dict) -> str:
    """
    Generates the content for /etc/shorewall/accounting using the nfacct method.
    """
    gs = config.get("global_settings", {}); leases_file = gs.get("dnsmasq_leases_file", "")
    active_leases = get_active_leases(leases_file) if leases_file else []
    
    header = [
        "# This file is auto-generated by inetctl. Do not edit manually.",
        "# Defines nfacct accounting objects for each active device.",
        "#",
        "# CHAIN              ACTION          SOURCE          DEST",
        # These master rules link the download/upload chains to the nfacct engine
        "download\tnfacct\t-\t\t-",
        "upload\t\tnfacct\t-\t\t-",
        ""
    ]
    # The rule format for nfacct is simple:
    # The ACTION is the name of the accounting object. The traffic that matches
    # the SOURCE/DEST will have its stats sent to that object.
    rules = []
    processed_macs = set()
    for device in active_leases:
        mac = device.get("mac")
        if not mac or mac in processed_macs: continue
        ip = device.get("ip")
        if not ip: continue
        
        object_name = f"inetctl_{mac.replace(':', '')}" # e.g., inetctl_d43a2ca02e50

        # Rule for traffic TO this host (download)
        rules.append(f"download\t{object_name}\t-\t\t{ip}")
        # Rule for traffic FROM this host (upload)
        rules.append(f"upload\t\t{object_name}\t{ip}\t\t-")

        processed_macs.add(mac)
    
    return "\n".join(header + rules) + "\n"

# The generate_mangle_rules function remains the same and is correct.
def generate_mangle_rules(config: Dict) -> str:
    # ... This function is unchanged from the last working version ...