<!DOCTYPE html>
<html>
<!-- The <head> and <style> sections are identical to the last complete version. -->
<body>
    <main class="container">
        <!-- ... Nav, Actions, and Tabs are unchanged ... -->
        <div class="tab-contents">
            {% for vlan_id in all_vlan_keys %}
            <div class="tab-content" {% if loop.first %}style="display: block;" {% endif %}>
                <!-- ... Active Devices Header is unchanged ... -->
                <div class="table-container">
                    <table>
                        <thead>
                            <!-- The header is now extended for the stats -->
                            <tr><th>Status</th><th>Assignment</th><th>Description / Hostname</th><th>MAC / IP</th><th style="text-align: right;">Live Stats</th><th style="text-align: right;">Actions</th></tr>
                        </thead>
                        <tbody>
                            {% for device in active_by_vlan.get(vlan_id, []) %}
                            <tr>
                                <td><span class="status-dot {{ 'blocked' if device.network_access_blocked else 'online' }}"></span></td>
                                <td><span class="assignment-badge {{ device.assignment_status|lower }}">{{ device.assignment_status }}</span></td>
                                <td><strong>{{ device.description }}</strong><br><small>{{ device.hostname }}</small></td>
                                <td><small>{{ device.mac }}<br>{{ device.ip }}</small></td>
                                <td style="text-align: right;">
                                    <!-- LIVE STATS restored. We'll show the text here -->
                                    <div id="stats-text-{{ device.mac.replace(':','') }}">
                                        <small>DL: 0.00 Mbps, UL: 0.00 Mbps</small>
                                    </div>
                                </td>
                                <td class="host-actions">
                                    <!-- LIVE STATS BUTTON restored -->
                                    <button class="outline" onclick="toggleChart('{{ device.mac.replace(':', '') }}')" title="Toggle Live Graph">ðŸ“Š</button>
                                    {% if current_user.role in ['admin', 'operator'] %}
                                    <button class="outline" onclick="openEditModal('{{ device.mac }}')">Edit</button>
                                    {% endif %}
                                </td>
                            </tr>
                            <!-- Hidden chart row restored -->
                            <tr id="chart-row-{{ device.mac.replace(':', '') }}" style="display: none;">
                                <td colspan="6" style="padding: 1rem !important; background-color: var(--pico-card-background-color);"><canvas id="chart-{{ device.mac.replace(':', '') }}" height="80"></canvas></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6">No active devices detected in this network.</td></tr> {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- ... Offline reservations table is unchanged ... -->
            </div>
            {% endfor %}
        </div>
    </main>

    <!-- ... Edit Modal is unchanged ... -->
    <script>
        let SYSTEM_CONFIG = {};
        const activeCharts = {};

        // --- FULL, RESTORED SCRIPT BLOCK ---
        document.addEventListener('DOMContentLoaded', async () => { /* ... tabs and config fetch ... */ });
        function showToast(message, type = 'info') { /* ... unchanged ... */ }
        async function queueJob(jobType, payload = {}) { /* ... unchanged ... */ }
        function pollJobStatus(jobId) { /* ... unchanged ... */ }
        function queueVlanToggle(vlanId, shouldBlock) { /* ... unchanged ... */ }
        const ipContainer = document.getElementById('ip-input');
        function buildIpInput(cidr = "") { /* ... unchanged ... */ }
        function getIpFromInput() { /* ... unchanged ... */ }
        async function openEditModal(mac) { /* ... unchanged ... */ }
        async function handleFormSubmit(e) { /* ... unchanged ... */ }

        // ----- LIVE STATS & CHARTING LOGIC (RESTORED & ENHANCED) -----
        function updateChartData(chartInstance) {
            const hostId = chartInstance.canvas.id.replace('chart-', '');
            fetch(`/data/bandwidth/${hostId}`)
                .then(response => response.json())
                .then(data => {
                    // Update chart
                    chartInstance.data.labels = data.labels;
                    chartInstance.data.datasets[0].data = data.datasets[0].data;
                    chartInstance.data.datasets[1].data = data.datasets[1].data;
                    chartInstance.update('none'); // Use 'none' for no animation

                    // Update text display
                    const statsText = document.getElementById(`stats-text-${hostId}`);
                    if (statsText && data.labels.length > 0) {
                        const lastIn = data.datasets[0].data.slice(-1)[0] || 0.0;
                        const lastOut = data.datasets[1].data.slice(-1)[0] || 0.0;
                        statsText.innerHTML = `<small>DL: ${lastIn.toFixed(2)} Mbps, UL: ${lastOut.toFixed(2)} Mbps</small>`;
                    }
                });
        }

        function createChart(hostId) {
            const ctx = document.getElementById(`chart-${hostId}`).getContext('2d');
            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], datasets: [
                        { label: 'Download (Mbps)', data: [], borderColor: '#1e88e5', tension: 0.2, pointRadius: 0 },
                        { label: 'Upload (Mbps)', data: [], borderColor: '#e53935', tension: 0.2, pointRadius: 0 }
                    ]
                },
                options: { animation: false, scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 12 } } } } }
            });
            const intervalId = setInterval(() => updateChartData(newChart), 5000); // Poll every 5 seconds
            activeCharts[hostId] = { chart: newChart, interval: intervalId };
            updateChartData(newChart);
        }

        function toggleChart(hostId) {
            const chartRow = document.getElementById(`chart-row-${hostId}`);
            if (chartRow.style.display === 'table-row') {
                chartRow.style.display = 'none';
                if (activeCharts[hostId]) {
                    clearInterval(activeCharts[hostId].interval);
                    activeCharts[hostId].chart.destroy();
                    delete activeCharts[hostId];
                }
            } else {
                chartRow.style.display = 'table-row';
                if (!activeCharts[hostId]) {
                    createChart(hostId);
                }
            }
        }
    </script>
</body>
</html>