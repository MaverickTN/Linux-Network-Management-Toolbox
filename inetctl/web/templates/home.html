<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ theme|capitalize }} | Linux Network Management Toolbox</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style id="theme-style">
    </style>
    <style>
      /* Profile Dropdown */
      #user-profile-menu { position: absolute; top: 1em; right: 1em; }
      #profile-menu-dropdown {
        display: none; position: absolute; right:0; background: var(--background, #23272e);
        color: var(--foreground, #fff); border-radius: var(--border-radius,10px);
        box-shadow: 0 4px 16px rgba(0,0,0,.12); min-width:240px; z-index:101;
      }
      #profile-menu-dropdown form { padding:1em; }
      #profile-menu-dropdown input, #profile-menu-dropdown select { width:100%; margin-bottom:0.4em;}
      #profile-menu-dropdown label { font-size: 0.98em;}
      #custom-theme-link { margin:0.5em 0; }
    </style>
</head>
<body>
    <div id="user-profile-menu">
      <button onclick="toggleProfileMenu()" style="background:var(--primary,#3498db);color:#fff;border-radius:50%;padding:0.7em 1em;">
        <span id="user-avatar">ðŸ‘¤</span>
      </button>
      <div id="profile-menu-dropdown">
        <form id="profile-form">
          <label>Email:<input id="user-email" type="email"></label>
          <label>New Password:<input id="user-password" type="password" autocomplete="new-password"></label>
          <label>Theme:
            <select id="theme-select"></select>
          </label>
          <div id="custom-theme-link"><a href="#" onclick="showCustomThemeModal();return false;">Create Custom Themeâ€¦</a></div>
          <label><input type="checkbox" id="notif-blocklist"> Blocklist events</label>
          <label><input type="checkbox" id="notif-job"> Job completion</label>
          <label><input type="checkbox" id="notif-schedule"> Schedule events</label>
          <div style="margin-top:0.7em;text-align:right;">
            <button type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
    <main class="container">
        <h1>Linux Network Management Toolbox</h1>
        <!-- rest of your dashboard here -->
        <div id="content-placeholder"></div>
    </main>
    <script>
    // --- Theme switching ---
    let currentTheme = "{{ theme }}";
    function applyTheme(themeName) {
        fetch("/api/theme/" + themeName).then(r=>r.json()).then(vars=>{
            let style = ":root{\n";
            for(let k in vars){ style += "--"+k.replace(/_/g,"-")+": "+vars[k]+";\n";}
            style += "}";
            document.getElementById("theme-style").textContent = style;
        });
    }
    applyTheme(currentTheme);
    // --- Profile Dropdown logic ---
    function toggleProfileMenu() {
        let menu = document.getElementById("profile-menu-dropdown");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    }
    document.addEventListener('click', function(e) {
        let menu = document.getElementById("profile-menu-dropdown");
        if (menu && !menu.contains(e.target) && !e.target.closest("#user-profile-menu")) {
            menu.style.display = "none";
        }
    });
    // --- Load profile data ---
    fetch('/api/profile').then(r=>r.json()).then(profile=>{
        document.getElementById("user-email").value = profile.email || "";
        document.getElementById("notif-blocklist").checked = !!profile.notif_blocklist;
        document.getElementById("notif-job").checked = !!profile.notif_job;
        document.getElementById("notif-schedule").checked = !!profile.notif_schedule;
        currentTheme = profile.theme || "dark";
        applyTheme(currentTheme);
    });
    // --- Load themes for dropdown ---
    fetch('/api/themes').then(r=>r.json()).then(themes=>{
        let sel = document.getElementById('theme-select');
        sel.innerHTML = "";
        for(let name in themes) {
            let opt = document.createElement('option');
            opt.value = name;
            opt.textContent = themes[name];
            sel.appendChild(opt);
        }
        sel.value = currentTheme;
    });
    // --- Handle theme switching ---
    document.getElementById('theme-select').onchange = function() {
        currentTheme = this.value;
        applyTheme(currentTheme);
    };
    // --- Save profile data ---
    document.getElementById('profile-form').onsubmit = function(e){
        e.preventDefault();
        let payload = {
            email: document.getElementById("user-email").value,
            password: document.getElementById("user-password").value,
            theme: document.getElementById("theme-select").value,
            notif_blocklist: document.getElementById("notif-blocklist").checked,
            notif_job: document.getElementById("notif-job").checked,
            notif_schedule: document.getElementById("notif-schedule").checked
        };
        fetch('/api/profile', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(data=>{
            Toastify({
                text: "Profile updated!",
                backgroundColor: "#43a047",
                duration: 3000
            }).showToast();
        });
    };
    function showCustomThemeModal(){
        Toastify({text: "Custom theme editor coming soon!", duration: 2500, backgroundColor: "#ff9800"}).showToast();
    }
    </script>
</body>
</html>
